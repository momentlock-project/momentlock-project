<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Document</title>
	<link rel="stylesheet" th:href="@{/css/main.css}" />
	<link rel="stylesheet" th:href="@{/css/nav.css}" />
	<link rel="stylesheet" th:href="@{/css/commons/main_btn.css}" />
	<link rel="stylesheet" th:href="@{/css/commons/common.css}" />
	<link rel="stylesheet" th:href="@{/css/box/myboxcapsulelist.css}" />
	<link rel="stylesheet" th:href="@{/css/box/boxdetail.css}" />
</head>

<body>
	<div th:replace="~{fragments/sidebar :: sidebar}"></div>
	<div id="mainContainer" class="blurContainer">
		<div th:replace="~{fragments/nav :: nav}"></div>
		<div class="my_boxdetail_list">
			<input type="hidden" id="boxId" th:value="${box.boxid}" />
			<input type="hidden" id="memberusername" th:value="${member.username}" />
			<input type="hidden" id="memerboxReadyCode" th:value="${memberBoxOne.readycode}" />

			<a href="#" id="closeBtn">
				<img src="/img/x.png" alt="창닫기" />
			</a>

			<!-- 상단 제목 -->
			<div class="list-header">
				<h1 th:text="${box.boxname}">상자 이름</h1>
			</div>

			<div class="top-row">
				<!-- ✅ 참여인원 → MemberCount -->
				<div class="memberCount">
					<button class="box-btn" id="join-member-btn">참여 인원</button>
					<span th:text="'박스에 참여 가능한 인원 : ' + ${box.boxmemcount}"></span>
				</div>
				<div class="action-buttons">
					<button class="btn-addCapsule" id="insert-capsule">캡슐 추가</button>
					<button th:if="${memberBoxOne.boxmatercode == 'MCB'}" class="box-btn" id="invite-btn">초대 하기</button>
				</div>
			</div>
			<div class="capsule-list">
				<div class="capsule-item" th:each="capsule, state : ${capsules}">
					<div class="capsule-info">
						<img th:src="@{|/img/capsule/${capsule.capImage ?: 'capsule1.png'}|}" alt="캡슐 썸네일" />
						<div class="capsule-text">
							<h3 th:text="${capsule.member?.username ?: '회원정보없음'}"></h3>
						</div>
					</div>
					<div class="dropdown"
						th:if="${capsule.member != null and member.username == capsule.member.username}">
						<button class="dropdown-toggle">⋮</button>
						<div class="dropdown-menu">
							<button class="modify-btn" th:data-capid="${capsule.capid}">수정</button>
							<button class="delete-btn" th:data-capid="${capsule.capid}">삭제</button>
						</div>
					</div>
				</div>
			</div>

			<!-- 준비하기 버튼 -->
			<div class="footer-btn">
				<button class="box-btn" id="ready-btn"
					th:classappend="${memberBoxOne.readycode == 'MRN' ? 'noready' : 'ready'}"
					th:text="${memberBoxOne.readycode == 'MRN' ? '준비 완료' : '준비 해제'}">
					준비 하기
				</button>
			</div>
		</div>

		<!-- 참여인원 모달-->
		<div class="modal-overlay" id="memberCountOverlay">
			<div id="memberCountModal" class="modal_4">
				<div class="modal-content">
					<h2>참여인원</h2>
					<div class="member-list">
						<div class="member-item" th:each="memberBox, state : ${memberBoxList}">
							<div class="left-info">
								<img th:src="@{${memberBox.readycode == 'MRY' ? '/img/ready.png' : '/img/no_ready.png'}}"
									alt="준비 상태" class="ready-status" />
								<span th:text="${memberBox.member.username}" class="nickname"></span>
								<!-- MCB면 방장 표시 -->
								<span th:if="${memberBox.boxmatercode == 'MCB'}" class="master-badge">방장</span>
							</div>
							<button th:if="${memberBox.boxmatercode != 'MCB' 
						                 and memberBoxOne.boxmatercode == 'MCB'
						                 and memberBox.member.username != memberBoxOne.member.username}" class="kick-btn"
								th:data-username="${memberBox.member.username}">
								내보내기
							</button>
						</div>
					</div>
					<button class="modal-confirm" id="memberCountConfirm">확인</button>
				</div>
			</div>
		</div>

		<!-- 초대하기 모달 추가 -->
		<div class="modal-overlay" id="inviteOverlay">
			<div id="inviteModal" class="modal_4" style="height: 45%;">
				<div class="modal-content">
					<!-- 박스에 자리가 있을 때 -->
					<div th:if="${#lists.size(memberBoxList) < box.boxmemcount}">
						<h2>멤버 초대하기</h2>

						<div class="invite-form">
							<label for="inviteNickname">초대할 닉네임</label>
							<input type="text" id="inviteNickname" placeholder="닉네임을 입력하세요" class="invite-input" />
							<p class="invite-hint">
								초대할 멤버의 닉네임을 정확히 입력해주세요.
								<span style="color: #ffd700; font-weight: bold;">
									(남은 자리: <span th:text="${box.boxmemcount - #lists.size(memberBoxList)}"></span>명)
								</span>
							</p>
						</div>

						<div class="modal-buttons">
							<button class="modal-confirm" id="inviteCancel">취소</button>
							<button class="modal-confirm" id="inviteConfirm">초대하기</button>
						</div>
					</div>

					<!-- 박스가 꽉 찼을 때 -->
					<div th:if="${#lists.size(memberBoxList) >= box.boxmemcount}" class="full-box-message">
						<h2>박스에 참여 가능한 자리가 없습니다.</h2>
						<p class="full-box-hint">박스 최대 인원 수정 또는 참여 인원을 내보내야 합니다.</p>

						<div class="modal-buttons">
							<button class="modal-confirm" id="inviteCancel">확인</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	</div>

	<div th:replace="~{fragments/footer :: footer}"></div>
	<script th:src="@{/js/nav.js}" defer></script>
	<script th:src="@{/js/box/boxdetail.js}" defer></script>

</body>

</html>